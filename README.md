# PhyloPlus

<details>
    <summary><b>Table of Contents</b></summary>
    <ol>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#dependencies">Dependencies</a></li>
        <ul>
            <li><a href="#python-388">Python</a></li>
            <li><a href="#r-410">R</a></li>
        </ul>
    <li><a href="#running-tests">Running Tests</a></li>
    <li><a href="#usage">Usage</a> </li>
        <ul>
            <li><a href="#download_ncbi_dump_files">Download NCBI Dump Files</a></li>
            <li><a href="#retrieve-complete-lineage-information">Retrieve Complete Lineage Information</a></li>
            <li><a href="#locate-species-within-the-reference-phylogeny">Locate Species Within the Reference Phylogeny</a></li>
            <li><a href="#perform-both-steps-consecutively">Perform Both Steps Consecutively</a></li>
        </ul>
    <li><a href="#output">Output</a></li>
    <li><a href="#supplementary-notes">Supplementary Notes</a></li>
        <ul>
            <li><a href="#reference-phylogenies">Reference Phylogenies</a></li>
            <li><a href="#thresholds">Thresholds</a></li>
            <li><a href="#tips-in-the-expanded-phylogeny">Tips in the Expanded Phylogeny</a></li>
        </ul>
    </ol>
</details>

## Introduction
This program will create a phylogeny where user specified species will be added to a publicly available, <a href="https:
//doi.org/10.1038/nbt.4229">peer reviewed</a> molecular bacterial or archaeal phylogeny. This approach takes advantage
of the comprehensive bacterial/archaeal molecular phylogenetic trees generated by Genome Taxonomy Database (GTDB), and
allows users to locate/insert their own customized set of bacterial or archaeal species within either of these
phylogenies. The addition of species to the original phylogeny is based on complete taxonomic lineage information that
is appended to all tips present in the tree, as well as lineage information retrieved for query species.

<p align="right">(<a href="#top">back to top</a>)</p>

## Dependencies
### Python 3.8.8
- biopython  1.78
- numpy  1.20.1
- pandas  1.2.4

### R 4.1.0
- phangorn  2.7.0  
- treeio  1.16.1   
- phytools  0.7-80
- maps  3.3.0      
- ape  5.5        
- castor  1.6.8    
- Rcpp  1.0.6      
- dplyr  1.0.6     
- tidytree  0.3.5

<p align="right">(<a href="#top">back to top</a>)</p>

## Running Tests
The following sample taxID input file and reference phylogeny are included in the `sample_data` directory and are set
as the default values for corresponding flags:

- `sample_taxIDs.txt` - a list of bacterial taxonomy IDs
- `sample_phylo.tree` - a subtree extracted from the bacterial reference phylogeny.

To test the program after installation of all dependencies, please run the following command using all default values to
execute the program on the sample input and phylogeny:

`./main.sh -m both -e your@email.com`

<p align="right">(<a href="#top">back to top</a>)</p>

## Usage
### Download NCBI Dump Files
This step is optional but **STRONGLY RECOMMENDED**. It will download NCBI dump files containing information related to
this program into the `NCBI_dmp_files` directory and process them into corresponding output files. The intermediate files
may take up ~2.3G disk space and the final output files may take up ~1.2G. However, this step helps to greatly reduce
the number of requests sent to the NCBI Entrez server by retrieving as much information as possible from these local
output files, and therefore reduces program running time by ~95% as for the step of lineage information extraction. To
download and process these dump files prior to running the main program , please run:

`./pre.sh`

### Retrieve Complete Lineage Information
To retrieve the most up-to-date complete lineage information for all genomes present in the reference phylogeny,
as well as for all non-redundant species identified in the reference phylogeny and the user-provided list, please run:

```
./main.sh -m extract -p <phylogeny path> -o <output directory> -i <input taxID path> -e <e-mail address>

    <phylogeny path>      =    Location of the reference phylogeny (default: ./sample_data/sample_phylo.tree)
    <output directory>    =    Directory to place all generated outputs, will create a directory if it does not
                               exist (default: ./sample_data/sample_output)
    <input taxID path>    =    Location of input taxID text file (default: ./sample_data/sample_taxIDs.txt)
    <e-mail address>      =    User's email address required by NCBI Entrez for batch processing
```

This step may take a long time to complete if the dump files have not been downloaded and processed prior to running the
main program (~1h for archaeal reference phylogeny, ~9h for bacterial reference phylogeny), due to the large number of
tips present in the reference phylogenies and a maximum of 3 requests per second required by NCBI Entrez, click <a href=
"https://www.ncbi.nlm.nih.gov/books/NBK25497#chapter2.Usage_Guidelines_and_Requirement">here</a> for more details.

To further save running time and disk space, as well as for easier use of PhyloPlus, a web tool implementation of this
program is made publicly available at http://phylo.jifsan.org where the dump files have already been downloaded and
processed, and the lineage information for reference phylogenies have already been retrieved and stored. The lineage information used in the web portal is updated monthly.

### Locate Species Within the Reference Phylogeny
Locating species within the reference phylogeny and the computation of the inserted branch length are constrained by
the group of reference tips that share the same taxID as the query species at the lowest possible taxonomic rank. To
perform this step, please run:

```
./main.sh -m expand -p <phylogeny path> -o <output directory> -t1 <threshold1> -t2 <threshold2> -t3 <threshold3> -t4
<threshold4>

    <phylogeny path>     =    Location of the reference phylogeny (default: ./sample_data/sample_phylo.tree)
    <output directory>   =    Directory to place all generated outputs, will create a directory if it does not
                              exist (default: ./sample_data/sample_output)
    <threshold 1>        =    The threshold for Z-score above which is used to detect outlier tips when locating
                              a query species that can mapped at the species level (default: 1)
    <threshold 2>        =    The threshold for Z-score above which is used to detect outlier tips when locating
                              a query species that can mapped at the species group level (default: 2)
    <threshold 3>        =    The threshold for Z-score above which is used to detect outlier tips when locating
                              a query species that can mapped at the genus level (default: 3)
    <threshold 4>        =    The threshold for the fraction above which is used to detect presence of an outlier
                              tip when only two reference tips are available to locate a species. The fraction used
                              is defined as (the distance to the MRCA node) / (the distance to the base root) for
                              the more distant tip (default: 0.75)
```

This step **REQUIRES** lineage summary files `tip_lineage.tsv`, `phylo_spp_lineage.tsv`, and `added_spp_lineage.tsv`
generated in the first step already been placed in the user-defined `<output directory>`.

### Perform Both Steps Consecutively
To perform both steps consecutively, please run:

```
./main.sh -m both -p <phylogeny path> -o <output directory> -i <input taxID path> - e <e-mail address> -t1 <threshold 1>
-t2 <threshold 2> -t3 <threshold 3> -t4 <threshold 4>
```

<p align="right">(<a href="#top">back to top</a>)</p>

## Output
All output files will be placed in the user-defined output directory, including:
- 4 newick tree files including:
   - 2 expanded trees (`expanded_taxIDs.tree`, `expanded_names.tree`) containing species in the user-provided list as
   well as non-redundant species present in the original reference phylogeny, with tip labels given in the form of
   taxonomy IDs and scientific names, respectively;
   - 2 simplified trees (`simplified_taxIDs.tree`, `simplified_names.tree`) that are extracted from the above expanded
   trees, containing only species present in the user-provided list.
- 3 complete lineage summary files (`tip_lineage.tsv`, `phylo_spp_lineage.tsv`, and `added_spp_lineage.tsv`) for all
tips in the reference phylogeny, non-redundant species present in the phylogeny, and non-redundant species provided by
the user, respectively.
- 1 summary file (`adding_tip_summary.tsv`) for the insertion of species detailing the taxonomic rank that a query
species can be mapped to the reference phylogeny, its assigned branch length, as well as the presence/absence of the
species in the reference phylogeny/user-provided sources.

<p align="right">(<a href="#top">back to top</a>)</p>

## Supplementary Notes
### Reference Phylogenies
The bacterial and archaeal reference phylogenies were downloaded from <a href="https://data.gtdb.ecogenomic.org/
releases/release202/">GTDB release 202</a> and underwent slight modifications: removal of node labels to
enable proper handling of tree files by some R packages; removal of 1 archaeal genome from the bacterial reference
phylogeny, and 3 bacterial genomes from the archaeal reference phylogeny, based on NCBI taxonomy and classification.
These reference phylogenies are placed in the `reference_phylo` directory to be used for generating user-customized
bacterial/archaeal phylogenies.

### Thresholds
Inference of insertion node of a query species is based on a group of tips in the reference phylogeny that share the
same taxonomy ID as the query species at a predetermined taxonomic rank. Taxonomic misclassification can produce
outlier tips within these groups that can lead to abnormally deep most recent common ancestor (MRCA) node, as well as
long branch length assigned to the inserted query species. Thresholds are set to detect and remove potential outlier
tips.

For groups containing more than two reference tips, detection and removal of potential outlier tips is made by first
calculating the average distance to remaining member tips for each reference tip within the group, and then calculating
the mean and standard deviation of these average distances. Outliers are then defined as the tips whose average distance
to other group members exceeds mean plus N times standard deviation (Z-score). Different thresholds are applied to
species that can be mapped at different taxonomic levels (species, species group and genus) and are specified by flags
t1, t2, and t3, respectively.

For groups containing only two member tips where the application of Z-score to detect potential outliers is impractical,
the fraction (the distance to the MRCA node) / (the distance to the base root) for the more distant tip is used to
indicate if this two-member group contains an outlier that leads to an MRCA node that is very close to the base root.
The outlier is then defined by comparing the lineage of these two member tips with their corresponding neighboring tips
within a subtree extracted by taking 2 nodes backward.

### Tips in the Expanded Phylogeny
The expanded phylogeny should contain **ALL** species present in the user-provided list, as well as a filtered list of
non-redundant species that are present in the original reference phylogeny. The only exception that a species from the
user-provided source may be removed from the tree is that the species can only be mapped at the superkingdom level. In
this case, the inference of its location is based on all tips of the phylogeny, which is computationally intensive and
biologically meaningless. The filtered list of non-redundant species from the reference phylogeny contains species that
at least have valid genus and species level taxonomy IDs. This helps to exclude "pseudo" species such as
Enterobacteriaceae bacterium (taxID: 1849603) that are assigned a "species" rank by NCBI taxonomy database but indeed
refer to higher-level classifications.

<p align="right">(<a href="#top">back to top</a>)</p>
